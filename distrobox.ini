[sar-lab]
image=ubuntu:24.04
pull=true
nvidia=true
start_now=true

# --- THE VAULT MOUNT ---
# Maps the ZFS HDD into the container at the exact same path
volume="/mnt/vault/sar_data:/mnt/vault/sar_data"

# --- SYSTEM DEPENDENCIES (Stable APT) ---
init_hooks="curl -fsSL https://deb.nodesource.com/setup_20.x | bash -"
additional_packages="git curl wget build-essential clang cmake"
additional_packages="gdal-bin libgdal-dev libnetcdf-dev libhdf5-dev"
additional_packages="htop nvtop tmux ripgrep fd-find"
additional_packages="zoxide fzf nodejs"

# --- MARLOW & SPYGLASS DEPENDENCIES ---
# Added requirements for QGIS Plugin development and OpenDrift
additional_packages="qgis python3-qgis pyqt5-dev-tools qttools5-dev-tools"
# Required for OpenCV, Gymnasium, and MuJoCo rendering
additional_packages="libgl1 libglx-mesa0 libosmesa6 libglu1-mesa libegl1 libgles2 xvfb"

# --- ENTRY HOOKS (Runtime Config) ---
# 1. Add User-NPM and Local Binaries to PATH (Sharing host tools)
entry_hooks="export PATH=$HOME/.npm-global/bin:$HOME/.local/bin:$PATH"

# 2. Force uv behavior
entry_hooks="export UV_VENV_IN_PROJECT=1"

# 3. Automatic QGIS Plugin Linking (Optional)
# Links your dev folder to the QGIS profile inside the container
entry_hooks="mkdir -p $HOME/.local/share/QGIS/QGIS3/profiles/default/python/plugins && ln -sfn $HOME/Projects/marlow/frontend/spyglass $HOME/.local/share/QGIS/QGIS3/profiles/default/python/plugins/spyglass"

# --- UI & RENDERING OPTIMIZATIONS ---
# 1. Force X11 for QGIS and Qt apps to bypass Wayland bugs
entry_hooks="export QT_QPA_PLATFORM=xcb"

# 2. Fix the SocketNotifier warning by ensuring DBUS is correctly mapped
entry_hooks="export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus"

# 3. Disable Wayland-specific decorations that cause flickering
entry_hooks="export QT_WAYLAND_DISABLE_WINDOWDECORATION=1"


# ==========================================
# PHASE 2: THE BRAIN (Local LLMs)
# ==========================================
[ai-lab]
image=ubuntu:24.04
pull=true
nvidia=true
start_now=true

# Minimal packages needed to install and run Ollama
additional_packages="curl git systemd zstd"

# Note: No custom volumes here. Models download to ~/.ollama 
# on your NVMe for maximum speed during this testing phase.
